#include <math.h>
#include "my_ekf.h"
float kalman(float mx, float my, float mz, float gz){
  float mx_adj = 0.95037898850682944740242419356946*mx + 0.0015268388984446511213999286837861*my + 0.075324780086728521100170041790989*mz + 17.293058074829864104932875514152;
  float my_adj = 0.0015268388984446511213999286837861*mx + 1.0185484214910351941085764337913*my + 0.0039219783446523930059424145611047*mz - 62.426988816567157839142951894273;
  float mz_adj = 0.075324780086728521100170041790989*mx + 0.0039219783446523930059424145611047*my + 1.0390370962455885983644066072884*mz + 60.930670563695438805760284168914;
  float m = atan2(mx_adj, my_adj);
  static float xhat0 = m;
  static float xhat1 = 0;
  float y = xhat0; // yhat(k) = xhat(k)
  xhat0 = 0.01*gz + 0.085060492147506772120379991974914*m + 0.91493950785249322787962000802509*xhat0 - 0.01*xhat1; // xhat(k+1) = G*gz+F*L*(m-C*xhat(k))+F*xhat(k)
  xhat1 = 0.30298008328690029244967263366561*xhat0 - 0.30298008328690029244967263366561*m + xhat1; // xhat(k+1) = G*gz+F*L*(m-C*xhat(k))+F*xhat(k)
  return y;
}